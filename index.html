<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Major Trauma Assessment Tool (UK)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #555; }
        .btn-normal { 
            font-size: 0.75rem; 
            padding: 0.25rem 0.5rem; 
            background-color: #e5e7eb; 
            color: #374151; 
            border-radius: 0.25rem; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-normal:hover { background-color: #d1d5db; }
        .highlight-section { border-left: 4px solid #f59e0b; }
        .proc-section { border-left: 4px solid #9333ea; }
        .mhp-section { border-left: 4px solid #dc2626; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-blue-700">Major Trauma Documentation</h1>
                <p class="text-xs text-gray-500">Trauma Call &middot; Primary & Secondary Survey</p>
            </div>
            <div class="text-right">
                <button id="resetBtn" class="text-xs text-red-500 hover:text-red-700 underline">Reset Form</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Column -->
            <div class="flex flex-col space-y-6">

                <!-- Team & ID -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Team & ID</h2>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div><label class="block text-xs font-medium text-gray-600">Patient ID / Sticker</label><input type="text" id="patientId" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Date/Time</label><input type="datetime-local" id="docTime" class="w-full px-2 py-1 border rounded text-sm"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-600">Team Leader</label><input type="text" id="teamLeader" class="w-full px-2 py-1 border rounded text-sm" placeholder="Name/Grade"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Scribe</label><input type="text" id="scribe" class="w-full px-2 py-1 border rounded text-sm" placeholder="Name/Grade"></div>
                    </div>
                </section>

                <!-- Specialty Attendances -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Specialty Attendances</h2>
                    <div class="flex flex-wrap gap-2 mb-2" id="specialty-buttons">
                        <button type="button" class="btn-normal" onclick="addSpecialty('Orthopaedics')">Ortho</button>
                        <button type="button" class="btn-normal" onclick="addSpecialty('Gen Surg')">Gen Surg</button>
                        <button type="button" class="btn-normal" onclick="addSpecialty('Anaesthetics')">Anaesthetics</button>
                        <button type="button" class="btn-normal" onclick="addSpecialty('Neuro')">Neuro</button>
                        <button type="button" class="btn-normal" onclick="addSpecialty('Plastics')">Plastics</button>
                    </div>
                    <textarea id="specialtyAttendances" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="e.g., Orthopaedics @ 14:35"></textarea>
                </section>

                <!-- ATMIST Handover -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">ATMIST Handover</h2>
                    <div class="grid grid-cols-3 gap-4 mb-3">
                        <div class="col-span-1">
                            <label for="age" class="block text-xs font-medium text-gray-600 mb-1">Age</label>
                            <input type="number" id="age" class="w-full px-2 py-1 border rounded text-sm" placeholder="Years">
                            <label class="flex items-center space-x-1 mt-1"><input type="checkbox" id="ageEstimated" class="h-3 w-3"><span class="text-xs">Est.</span></label>
                        </div>
                        <div class="col-span-2">
                             <label for="timeOfIncident" class="block text-xs font-medium text-gray-600 mb-1">Time of Incident</label>
                             <input type="time" id="timeOfIncident" class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                    
                    <!-- WETFLAG CONTAINER -->
                    <div id="wetflagContainer" class="hidden bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
                        <h3 class="text-sm font-bold text-blue-800 mb-1">WETFLAG (Paediatric Guide)</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-blue-900" id="wetflagOutput"></div>
                    </div>

                    <div class="space-y-3">
                        <div><label class="block text-xs font-medium text-gray-600">Mechanism</label><textarea id="mechanism" rows="2" class="w-full px-2 py-1 border rounded text-sm"></textarea></div>
                        <div><label class="block text-xs font-medium text-gray-600">Injuries Suspected</label><textarea id="injuries" rows="2" class="w-full px-2 py-1 border rounded text-sm"></textarea></div>
                        <div><label class="block text-xs font-medium text-gray-600">Pre-Hospital Signs</label><input type="text" id="signs" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. GCS 13 HR 120"></div>
                        <div class="bg-gray-50 p-2 rounded border">
                            <label class="block text-xs font-bold text-gray-700 mb-1">Pre-Hospital Treatment Given</label>
                            <textarea id="preHospitalTx" rows="2" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. TXA 1g, 1L Saline, Splinting..."></textarea>
                        </div>
                    </div>
                </section>

                <!-- <C> Catastrophic Haemorrhage -->
                <section class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">&lt;C&gt; Catastrophic Haemorrhage</h2>
                    <div class="flex gap-4 mb-2">
                        <label class="flex items-center space-x-2"><input type="radio" name="catHaem" value="No" checked class="text-red-600"><span>No</span></label>
                        <label class="flex items-center space-x-2"><input type="radio" name="catHaem" value="Yes" class="text-red-600 font-bold"><span>Yes</span></label>
                    </div>
                    <div id="catHaemDetails" class="hidden space-y-2 mt-2">
                        <input type="text" id="catHaem_details" class="w-full px-2 py-1 border rounded text-sm" placeholder="Site of bleeding">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="catHaem_tourniquet" class="w-full px-2 py-1 border rounded text-sm" placeholder="Tourniquet Time/Site">
                            <input type="text" id="catHaem_intervention" class="w-full px-2 py-1 border rounded text-sm" placeholder="Other Interventions">
                        </div>
                    </div>
                </section>

                <!-- Primary Survey (A) -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-700 border-b pb-2 mb-3">A - Airway & C-Spine</h2>
                    <div class="flex flex-wrap gap-4 mb-3">
                         <label class="flex items-center space-x-2"><input type="radio" name="airwayStatus" value="Patent" checked class="text-blue-600"><span>Patent</span></label>
                         <label class="flex items-center space-x-2"><input type="radio" name="airwayStatus" value="Compromised" class="text-blue-600"><span>Compromised</span></label>
                         <label class="flex items-center space-x-2"><input type="radio" name="airwayStatus" value="At Risk" class="text-blue-600"><span>At Risk</span></label>
                    </div>
                    <div class="mb-3">
                        <p class="text-xs font-medium text-gray-600 mb-1">Adjuncts / Interventions</p>
                        <div class="flex flex-wrap gap-3" id="airway_adjuncts"></div>
                    </div>
                    <div class="flex items-center space-x-2 mb-3 bg-yellow-50 p-2 rounded">
                        <input type="checkbox" id="cSpineImmobilised" class="text-blue-600 rounded">
                        <span class="text-sm font-medium">C-Spine Immobilised (Collar/Blocks)</span>
                    </div>
                    <textarea id="airway_notes" rows="1" class="w-full px-2 py-1 border rounded text-sm" placeholder="Notes (e.g. suction, secretions)"></textarea>
                </section>

                <!-- Primary Survey (B) -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-700 border-b pb-2 mb-3">B - Breathing</h2>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-600">RR</label><input type="number" id="breathing_rr" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs text-gray-600">Sats (%)</label><input type="number" id="breathing_sats" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs text-gray-600">O2 Delivery</label><input type="text" id="breathing_o2_method" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. 15L NRB"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-600">Trachea</label>
                            <select id="breathing_trachea" class="w-full px-2 py-1 border rounded text-sm bg-white">
                                <option>Central</option>
                                <option>Deviated Right</option>
                                <option>Deviated Left</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-600">Air Entry</label><input type="text" id="breathing_auscultation" value="Equal bilaterally" class="w-full px-2 py-1 border rounded text-sm"></div>
                    </div>
                    <div class="mb-3">
                        <p class="text-xs font-medium text-gray-600 mb-1">Findings</p>
                        <div id="breathing_findings" class="space-y-1"></div>
                    </div>
                    <textarea id="breathing_notes" rows="1" class="w-full px-2 py-1 border rounded text-sm" placeholder="Interventions (e.g. Drain)"></textarea>
                </section>

                <!-- Primary Survey (C) -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-700 border-b pb-2 mb-3">C - Circulation</h2>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <div><label class="block text-xs text-gray-600">HR</label><input type="number" id="circ_hr" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs text-gray-600">BP (Sys)</label><input type="number" id="circ_bp_sys" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs text-gray-600">BP (Dia)</label><input type="number" id="circ_bp_dia" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs text-gray-600">Shock Index</label><input type="text" readonly id="shock_index" class="w-full px-2 py-1 border rounded text-sm bg-gray-100 text-gray-500"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-600">Cap Refill (s)</label><input type="number" id="circ_capRefill" class="w-full px-2 py-1 border rounded text-sm"></div>
                         <div><label class="block text-xs text-gray-600">Pelvis Stability</label>
                            <select id="circ_pelvis" class="w-full px-2 py-1 border rounded text-sm bg-white">
                                <option>Stable</option>
                                <option>Unstable</option>
                                <option>Binder Applied</option>
                                <option>Not Assessed</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 border-t pt-2">
                        <p class="text-xs font-medium text-gray-600 mb-1">Access</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm" id="access_checkboxes"></div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded mb-3 border border-blue-100">
                        <p class="text-xs font-bold text-blue-800 mb-1">Fluid Resuscitation</p>
                        <div class="flex items-center space-x-1 mb-2">
                             <input type="checkbox" id="txaGiven" class="h-4 w-4 text-blue-600"><span>TXA Given</span>
                        </div>
                        <input type="text" id="fluidsGiven" class="w-full px-2 py-1 border rounded text-sm mb-1" placeholder="Fluids Given (e.g. 1L Saline)">
                    </div>
                </section>

                <!-- Major Haemorrhage Protocol Section (New Location) -->
                <section class="bg-white p-4 rounded-xl shadow mhp-section">
                    <h2 class="text-lg font-bold text-red-800 border-b border-red-200 pb-2 mb-3">Major Haemorrhage Protocol (MHP)</h2>
                    <div class="mb-3">
                        <label class="flex items-center space-x-2 text-red-900 font-bold">
                            <input type="checkbox" id="mhpActivated" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <span>MHP ACTIVATED</span>
                        </label>
                    </div>
                    
                    <!-- MHP PRODUCTS SECTION -->
                    <div class="mt-2 hidden bg-white p-3 rounded border border-red-200 shadow-sm" id="mhp_products_container">
                        <h4 class="text-xs font-bold text-gray-700 mb-2 border-b border-gray-100 pb-1">Products Administered</h4>
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div><label class="block text-[10px] uppercase font-bold text-gray-500">Packs</label><input type="number" id="mhp_packs" class="w-full px-2 py-1 border rounded text-sm"></div>
                            <div><label class="block text-[10px] uppercase font-bold text-gray-500">PRBC (Units)</label><input type="number" id="mhp_prbc" class="w-full px-2 py-1 border rounded text-sm"></div>
                            <div><label class="block text-[10px] uppercase font-bold text-gray-500">FFP (Units)</label><input type="number" id="mhp_ffp" class="w-full px-2 py-1 border rounded text-sm"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-[10px] uppercase font-bold text-gray-500">Platelets</label><input type="number" id="mhp_plt" class="w-full px-2 py-1 border rounded text-sm"></div>
                            <div><label class="block text-[10px] uppercase font-bold text-gray-500">Cryo/Fib</label><input type="number" id="mhp_cryo" class="w-full px-2 py-1 border rounded text-sm"></div>
                        </div>
                    </div>
                </section>

                <!-- Primary Survey (D) -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-700 border-b pb-2 mb-3">D - Disability</h2>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <div><label class="block text-xs text-gray-600">AVPU</label>
                            <select id="disability_avpu" class="w-full px-1 py-1 border rounded text-sm bg-white">
                                <option>Alert</option><option>Voice</option><option>Pain</option><option>Unresp</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-600">GCS (E)</label><select id="disability_gcsE" class="w-full px-1 py-1 border rounded text-sm bg-white"></select></div>
                        <div><label class="block text-xs text-gray-600">GCS (V)</label><select id="disability_gcsV" class="w-full px-1 py-1 border rounded text-sm bg-white"></select></div>
                        <div><label class="block text-xs text-gray-600">GCS (M)</label><select id="disability_gcsM" class="w-full px-1 py-1 border rounded text-sm bg-white"></select></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                         <div class="col-span-1"><label class="block text-xs text-gray-600">Total GCS</label><input type="text" readonly id="gcsTotal" class="w-full px-2 py-1 bg-gray-100 rounded text-sm font-bold"></div>
                         <div class="col-span-1"><label class="block text-xs text-gray-600">Pupils</label><input type="text" id="pupils" value="PEARL 3mm" class="w-full px-2 py-1 border rounded text-sm"></div>
                         <div class="col-span-1"><label class="block text-xs text-gray-600">Glucose</label><input type="number" id="disability_glucose" class="w-full px-2 py-1 border rounded text-sm"></div>
                    </div>
                    <div class="border-t pt-2 mt-2">
                         <label class="block text-xs font-semibold text-gray-700 mb-1">Limb Movement (Tick if moving)</label>
                         <div class="grid grid-cols-2 gap-2 text-sm bg-gray-50 p-2 rounded">
                            <label class="flex items-center space-x-2"><input type="checkbox" id="move_la" checked><span>L Arm</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="move_ra" checked><span>R Arm</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="move_ll" checked><span>L Leg</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="move_rl" checked><span>R Leg</span></label>
                         </div>
                    </div>
                </section>

                <!-- Primary Survey (E) -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-700 border-b pb-2 mb-3">E - Exposure</h2>
                    <div class="flex items-center space-x-4 mb-3">
                        <div class="w-1/3"><label class="block text-xs text-gray-600">Temp (°C)</label><input type="number" id="exposure_temp" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div class="w-2/3 flex flex-col gap-1">
                             <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="warm_bair" class="text-blue-600"><span>Bair Hugger</span></label>
                             <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="warm_fluids" class="text-blue-600"><span>Fluids Warmed</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Other Findings</label>
                        <textarea id="exposure_notes" rows="2" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. rashes, long bone deformity, wounds"></textarea>
                    </div>
                </section>

                <!-- Investigations -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Investigations (FAST / VBG)</h2>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 mb-1">EFAST</label>
                        <div id="efast_views" class="flex flex-wrap gap-2 text-xs mb-2"></div>
                        <textarea id="efast_summary" rows="1" class="w-full px-2 py-1 border rounded text-sm" placeholder="Summary (e.g. Positive RUQ)"></textarea>
                    </div>
                    <div class="mb-2">
                         <label class="block text-xs font-bold text-gray-700 mb-1">VBG / ABG</label>
                         <div class="grid grid-cols-4 gap-2">
                            <input type="number" id="vbg_ph" placeholder="pH" class="w-full px-1 py-1 border rounded text-sm">
                            <input type="number" id="vbg_base" placeholder="BE" class="w-full px-1 py-1 border rounded text-sm">
                            <input type="number" id="vbg_lac" placeholder="Lac" class="w-full px-1 py-1 border rounded text-sm text-red-600 font-medium">
                            <input type="number" id="vbg_hb" placeholder="Hb" class="w-full px-1 py-1 border rounded text-sm">
                         </div>
                    </div>
                </section>

                <!-- Immediate Management -->
                <section class="bg-white p-4 rounded-xl shadow highlight-section">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Immediate Management & Imaging</h2>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-blue-700 mb-1 uppercase">Analgesia (Encouraged)</label>
                        <textarea id="mgmt_analgesia" rows="1" class="w-full px-2 py-1 border border-blue-200 rounded text-sm bg-blue-50" placeholder="e.g. Morphine 5mg IV, Fentanyl 50mcg..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Imaging Requests</label>
                        <textarea id="mgmt_imaging" rows="2" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. CT Trauma Pan Scan (Head to Pelvis), XR Chest/Pelvis..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Specialty Referrals / Interventions</label>
                        <textarea id="mgmt_referrals" rows="2" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g. General Surgery review requested..."></textarea>
                    </div>
                </section>

                <!-- Advanced Interventions Section -->
                <section class="bg-white p-4 rounded-xl shadow proc-section">
                    <details>
                        <summary class="cursor-pointer text-lg font-bold text-purple-800 focus:outline-none flex justify-between">
                            <span>Advanced Interventions</span>
                            <span class="text-xs text-purple-500 font-normal self-center">(Click to Open)</span>
                        </summary>
                        <div class="mt-3 grid grid-cols-2 gap-3">
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_rsi" class="text-purple-600"><span>RSI</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_artline" class="text-purple-600"><span>Arterial Line</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_thoracostomy" class="text-purple-600"><span>Finger Thoracostomy</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_chest_drain" class="text-purple-600"><span>Chest Drain</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_thoracotomy" class="text-purple-600"><span>Resus Thoracotomy</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_hysterotomy" class="text-purple-600"><span>Resus Hysterotomy</span></label>
                            <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="proc_reboa" class="text-purple-600"><span>REBOA</span></label>
                        </div>
                        <div class="mt-3">
                            <label class="block text-xs font-bold text-gray-700 mb-1">Procedure Notes</label>
                            <textarea id="proc_notes" rows="3" class="w-full px-2 py-1 border rounded text-sm" placeholder="Details of procedures performed..."></textarea>
                        </div>
                    </details>
                </section>
                
                <!-- Plan -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Plan & Destination</h2>
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Immediate Destination</label>
                        <select id="destination" class="w-full px-2 py-1 border rounded text-sm bg-white mb-3">
                            <option value="">-- Select --</option>
                            <option>CT Scanner</option>
                            <option>Operating Theatre</option>
                            <option>Interventional Radiology</option>
                            <option>ICU / Critical Care</option>
                            <option>Ward</option>
                            <option>Transfer to MTC</option>
                            <option>Discharge</option>
                        </select>
                    </div>
                    <textarea id="plan" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Summary of plan..."></textarea>
                </section>

                <!-- Secondary Survey -->
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Secondary Survey</h2>
                    <p class="text-xs text-gray-500 mb-3">Click 'Normal' to pre-fill standard findings. (Usually performed post-imaging)</p>
                    
                    <!-- Macro for generating sec survey fields -->
                    <div id="secondarySurveyContainer" class="space-y-3"></div>

                    <div class="mt-4 border-t pt-2">
                        <label class="block text-sm font-bold text-gray-700">Problem List</label>
                        <textarea id="problemList" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mt-1"></textarea>
                    </div>
                </section>

            </div>

            <!-- Output Column -->
            <div class="sticky top-24 self-start">
                <section class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h2 class="text-lg font-bold text-blue-700">Generated Note</h2>
                        <button id="copyAll" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition">COPY ALL</button>
                    </div>
                    <textarea readonly id="finalOutput" class="w-full h-[85vh] p-3 bg-gray-50 border border-gray-300 rounded-md font-mono text-xs whitespace-pre-wrap leading-relaxed text-gray-800" aria-label="Generated note"></textarea>
                </section>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTS ---
            const GCS_E = [ {v:4, l:'4-Spontaneous'}, {v:3, l:'3-Voice'}, {v:2, l:'2-Pain'}, {v:1, l:'1-None'} ];
            const GCS_V = [ {v:5, l:'5-Oriented'}, {v:4, l:'4-Confused'}, {v:3, l:'3-Inapprop'}, {v:2, l:'2-Sounds'}, {v:1, l:'1-None'} ];
            const GCS_M = [ {v:6, l:'6-Obeys'}, {v:5, l:'5-Localises'}, {v:4, l:'4-Withdraws'}, {v:3, l:'3-Flexion'}, {v:2, l:'2-Extension'}, {v:1, l:'1-None'} ];
            
            const AIRWAY_ADJUNCTS = ['OPA', 'NPA', 'iGel', 'ETT', 'Suction', 'RSI'];
            const BREATHING_FINDINGS = ['Surg Emphysema', 'Crepitus', 'Flail Seg', 'Open Wound', 'Dullness', 'Wheeze', 'Silent'];
            const EFAST_VIEWS = ["RUQ", "LUQ", "Pelvic", "Heart", "Lung Slide"];
            const ACCESS_SITES = ['L ACF', 'R ACF', 'L Hand', 'R Hand', 'L EJ', 'R EJ', 'IO Hum (L)', 'IO Hum (R)', 'IO Tib (L)', 'IO Tib (R)', 'CVC'];

            const SECONDARY_ZONES = [
                { id: 'ss_head', label: 'Head', normal: 'Normocephalic, no boggy masses, no lacerations.' },
                { id: 'ss_eyes', label: 'Eyes/Face', normal: 'No bony tenderness. PEARL. EOMI. No septal haematoma.' },
                { id: 'ss_neck', label: 'Neck', normal: 'Trachea central. No step deformity. No sub-cut emphysema. Collar in situ.' },
                { id: 'ss_chest', label: 'Chest', normal: 'Symmetrical expansion. No bruising. Non-tender sternum/ribs. Breath sounds equal.' },
                { id: 'ss_abdo', label: 'Abdomen', normal: 'Soft, non-tender. No bruising. No distension.' },
                { id: 'ss_pelvis', label: 'Pelvis', normal: 'Stable. Non-tender.' },
                { id: 'ss_back', label: 'Back', normal: 'Log roll performed. No spinal tenderness. No steps. PR: Normal tone.' },
                { id: 'ss_limbs', label: 'Limbs', normal: 'No obvious deformity. Soft compartments. Pulses intact x4.' },
                { id: 'ss_neuro', label: 'Neuro', normal: 'GCS 15. Moves all 4 limbs. Power 5/5. Sensation intact.' }
            ];

            // --- STATE OBJECT ---
            const state = {
                specialties: [],
                adjuncts: [],
                breathingFindings: [],
                efastViews: [],
                access: [],
                wetflag: null
            };

            // --- INIT FUNCTIONS ---

            function init() {
                // Populate Dropdowns
                fillSelect('disability_gcsE', GCS_E, 4);
                fillSelect('disability_gcsV', GCS_V, 5);
                fillSelect('disability_gcsM', GCS_M, 6);
                
                // Generate Checkboxes
                createCheckboxes('airway_adjuncts', AIRWAY_ADJUNCTS, 'adjuncts');
                createCheckboxes('breathing_findings', BREATHING_FINDINGS, 'breathingFindings', true);
                createCheckboxes('efast_views', EFAST_VIEWS, 'efastViews');
                createCheckboxes('access_checkboxes', ACCESS_SITES, 'access');

                // Generate Secondary Survey Areas
                const ssContainer = document.getElementById('secondarySurveyContainer');
                SECONDARY_ZONES.forEach(zone => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div class="flex justify-between items-end mb-1">
                            <label class="text-xs font-semibold text-gray-700">${zone.label}</label>
                            <button class="btn-normal text-[10px]" onclick="fillNormal('${zone.id}', '${zone.normal}')">Normal</button>
                        </div>
                        <textarea id="${zone.id}" rows="1" class="w-full px-2 py-1 border rounded text-sm"></textarea>
                    `;
                    ssContainer.appendChild(div);
                });

                // Set Default Time
                const now = new Date();
                const nowString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('docTime').value = nowString;

                // Bind Listeners
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    el.addEventListener('input', updateOutput);
                    el.addEventListener('change', updateOutput);
                });

                // Specific Listeners
                document.getElementById('age').addEventListener('input', updateWETFLAG);
                document.getElementById('circ_hr').addEventListener('input', calcShockIndex);
                document.getElementById('circ_bp_sys').addEventListener('input', calcShockIndex);
                document.getElementById('disability_gcsE').addEventListener('change', calcGCS);
                document.getElementById('disability_gcsV').addEventListener('change', calcGCS);
                document.getElementById('disability_gcsM').addEventListener('change', calcGCS);
                
                // MHP Listener
                document.getElementById('mhpActivated').addEventListener('change', (e) => {
                    const container = document.getElementById('mhp_products_container');
                    if(e.target.checked) container.classList.remove('hidden');
                    else container.classList.add('hidden');
                    updateOutput();
                });

                // Catastrophic Haem Listener
                document.querySelectorAll('input[name="catHaem"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const details = document.getElementById('catHaemDetails');
                        if(e.target.value === 'Yes') details.classList.remove('hidden');
                        else details.classList.add('hidden');
                        updateOutput();
                    });
                });

                document.getElementById('copyAll').addEventListener('click', copyToClipboard);
                document.getElementById('resetBtn').addEventListener('click', () => {
                    if(confirm('Clear all data?')) { location.reload(); }
                });

                // Initial run
                updateWETFLAG();
                calcGCS();
                updateOutput();
            }

            // --- HELPERS ---

            function fillSelect(id, opts, def) {
                const sel = document.getElementById(id);
                opts.forEach(o => sel.add(new Option(o.l, o.v)));
                sel.value = def;
            }

            function createCheckboxes(containerId, items, stateKey, withSide = false) {
                const container = document.getElementById(containerId);
                items.forEach(item => {
                    if (withSide) {
                        // For breathing findings (L/R)
                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center text-xs bg-gray-50 p-1 rounded";
                        div.innerHTML = `<span>${item}</span> 
                            <div class="flex space-x-2">
                                <label class="flex items-center"><input type="checkbox" data-val="${item} (L)" class="mr-1">L</label>
                                <label class="flex items-center"><input type="checkbox" data-val="${item} (R)" class="mr-1">R</label>
                            </div>`;
                        container.appendChild(div);
                        div.querySelectorAll('input').forEach(chk => {
                            chk.addEventListener('change', (e) => {
                                if (e.target.checked) state[stateKey].push(e.target.dataset.val);
                                else state[stateKey] = state[stateKey].filter(x => x !== e.target.dataset.val);
                                updateOutput();
                            });
                        });
                    } else {
                        // Standard checkboxes
                        const lbl = document.createElement('label');
                        lbl.className = "flex items-center space-x-1 cursor-pointer";
                        lbl.innerHTML = `<input type="checkbox" value="${item}" class="h-3 w-3 text-blue-600 rounded"><span>${item}</span>`;
                        container.appendChild(lbl);
                        lbl.querySelector('input').addEventListener('change', (e) => {
                            if (e.target.checked) state[stateKey].push(item);
                            else state[stateKey] = state[stateKey].filter(x => x !== item);
                            updateOutput();
                        });
                    }
                });
            }

            window.fillNormal = (id, text) => {
                document.getElementById(id).value = text;
                updateOutput();
            };

            window.addSpecialty = (spec) => {
                const el = document.getElementById('specialtyAttendances');
                const current = el.value;
                const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                el.value = current ? `${current}, ${spec} @ ${time}` : `${spec} @ ${time}`;
                updateOutput();
            };

            // --- LOGIC ---

            function updateWETFLAG() {
                const age = parseFloat(document.getElementById('age').value);
                const container = document.getElementById('wetflagContainer');
                const output = document.getElementById('wetflagOutput');
                
                if (!age || age >= 12) {
                    container.classList.add('hidden');
                    state.wetflag = null;
                    updateOutput();
                    return;
                }

                container.classList.remove('hidden');
                
                // Formulas (APLS)
                const weight = (age + 4) * 2;
                const energy = weight * 4;
                const tube = (age / 4) + 4;
                const fluid = weight * 10; 
                const lorazepam = weight * 0.1;
                const adrenaline = weight * 0.1; 

                const html = `
                    <div><span class="font-bold">Wt:</span> ${weight}kg</div>
                    <div><span class="font-bold">Tube:</span> ${tube}mm</div>
                    <div><span class="font-bold">Energy:</span> ${energy}j</div>
                    <div><span class="font-bold">Fluid:</span> ${fluid}ml (10ml/kg)</div>
                    <div class="col-span-2 text-gray-500 italic mt-1 text-[10px]">Verify all drug doses</div>
                `;
                output.innerHTML = html;
                state.wetflag = { weight, energy, tube, fluid };
                updateOutput();
            }

            function calcShockIndex() {
                const hr = parseFloat(document.getElementById('circ_hr').value);
                const sbp = parseFloat(document.getElementById('circ_bp_sys').value);
                const el = document.getElementById('shock_index');
                if (hr && sbp && sbp > 0) {
                    const si = (hr / sbp).toFixed(2);
                    el.value = si;
                    if(si > 1.0) { el.classList.add('bg-red-100', 'text-red-800'); el.classList.remove('bg-gray-100'); }
                    else { el.classList.remove('bg-red-100', 'text-red-800'); el.classList.add('bg-gray-100'); }
                } else {
                    el.value = '';
                }
                updateOutput();
            }

            function calcGCS() {
                const e = parseInt(document.getElementById('disability_gcsE').value) || 0;
                const v = parseInt(document.getElementById('disability_gcsV').value) || 0;
                const m = parseInt(document.getElementById('disability_gcsM').value) || 0;
                document.getElementById('gcsTotal').value = e + v + m;
                updateOutput();
            }

            // --- NOTE GENERATOR ---

            function val(id) { return document.getElementById(id)?.value || ''; }
            function chk(id) { return document.getElementById(id)?.checked; }
            function rad(name) { return document.querySelector(`input[name="${name}"]:checked`)?.value || ''; }

            function updateOutput() {
                const date = val('docTime').replace('T', ' ');
                const pid = val('patientId') || 'Unknown ID';
                const team = `Leader: ${val('teamLeader') || 'N/S'} | Scribe: ${val('scribe') || 'N/S'}`;
                
                let t = `MAJOR TRAUMA DOCUMENTATION\n`;
                t += `Date: ${date}\nID: ${pid}\n${team}\n`;
                t += `Specialties: ${val('specialtyAttendances')}\n`;
                t += `----------------------------------------\n`;
                
                // ATMIST
                t += `ATMIST HANDOVER\n`;
                t += `Age: ${val('age')} ${chk('ageEstimated')?'(Est)':''} | Time: ${val('timeOfIncident')}\n`;
                if(state.wetflag) {
                    t += `[Paed WETFLAG: Wt ${state.wetflag.weight}kg | Tube ${state.wetflag.tube} | Fluid ${state.wetflag.fluid}ml]\n`;
                }
                t += `Mech: ${val('mechanism')}\n`;
                t += `Injuries Suspected: ${val('injuries')}\n`;
                t += `Pre-Hosp Signs: ${val('signs')}\n`;
                if(val('preHospitalTx')) t += `Pre-Hosp Tx: ${val('preHospitalTx')}\n`;
                t += `\n`;

                // PRIMARY SURVEY
                t += `PRIMARY SURVEY\n`;
                
                // <C>
                const isCatHaem = rad('catHaem') === 'Yes';
                t += `<C> Catastrophic Haemorrhage: ${rad('catHaem').toUpperCase()}\n`;
                if(isCatHaem) t += `   Details: ${val('catHaem_details')} | TNQ: ${val('catHaem_tourniquet')} | Int: ${val('catHaem_intervention')}\n`;

                // A
                t += `[A] Airway: ${rad('airwayStatus').toUpperCase()}\n`;
                if(state.adjuncts.length) t += `    Adjuncts: ${state.adjuncts.join(', ')}\n`;
                if(chk('cSpineImmobilised')) t += `    C-Spine: IMMOBILISED\n`;
                if(val('airway_notes')) t += `    Notes: ${val('airway_notes')}\n`;

                // B
                t += `[B] Breathing: RR ${val('breathing_rr')} | Sats ${val('breathing_sats')}% | ${val('breathing_o2_method')}\n`;
                t += `    Trachea: ${val('breathing_trachea')} | Air Entry: ${val('breathing_auscultation')}\n`;
                if(state.breathingFindings.length) t += `    Findings: ${state.breathingFindings.join(', ')}\n`;
                if(val('breathing_notes')) t += `    Notes: ${val('breathing_notes')}\n`;

                // C
                t += `[C] Circulation: HR ${val('circ_hr')} | BP ${val('circ_bp_sys')}/${val('circ_bp_dia')} | Shock Index: ${val('shock_index')}\n`;
                t += `    CRT: ${val('circ_capRefill')}s | Pelvis: ${val('circ_pelvis')}\n`;
                if(state.access.length) t += `    Access: ${state.access.join(', ')}\n`;
                const txa = chk('txaGiven') ? 'YES' : 'No';
                t += `    TXA Given: ${txa}\n`;
                if(val('fluidsGiven')) t += `    Fluids: ${val('fluidsGiven')}\n`;
                
                // MHP Output
                if(chk('mhpActivated')) {
                    t += `    !!! MHP ACTIVATED !!!\n`;
                    t += `    Products: Packs[${val('mhp_packs')}] PRBC[${val('mhp_prbc')}] FFP[${val('mhp_ffp')}] Plt[${val('mhp_plt')}] Cryo[${val('mhp_cryo')}]\n`;
                }

                // D
                const gcsTotal = val('gcsTotal');
                t += `[D] Disability: GCS ${gcsTotal} (E${val('disability_gcsE')} V${val('disability_gcsV')} M${val('disability_gcsM')})\n`;
                t += `    AVPU: ${val('disability_avpu')} | Pupils: ${val('pupils')} | BM: ${val('disability_glucose')}\n`;
                // Limb Movement Logic
                const mv_la = chk('move_la') ? 'Y' : 'N';
                const mv_ra = chk('move_ra') ? 'Y' : 'N';
                const mv_ll = chk('move_ll') ? 'Y' : 'N';
                const mv_rl = chk('move_rl') ? 'Y' : 'N';
                t += `    Moving: L Arm [${mv_la}] R Arm [${mv_ra}] L Leg [${mv_ll}] R Leg [${mv_rl}]\n`;

                // E
                t += `[E] Exposure: Temp ${val('exposure_temp')}°C\n`;
                const warming = [];
                if(chk('warm_bair')) warming.push('Bair Hugger');
                if(chk('warm_fluids')) warming.push('Fluid Warmer');
                if(warming.length) t += `    Warming: ${warming.join(', ')}\n`;
                if(val('exposure_notes')) t += `    Notes: ${val('exposure_notes')}\n`;

                t += `----------------------------------------\n`;
                
                // INVESTIGATIONS
                t += `INVESTIGATIONS\n`;
                if(state.efastViews.length || val('efast_summary')) {
                    t += `EFAST: ${val('efast_summary') || 'Done'} (${state.efastViews.join(', ')})\n`;
                }
                if(val('vbg_ph')) {
                    t += `VBG: pH ${val('vbg_ph')} / BE ${val('vbg_base')} / Lac ${val('vbg_lac')} / Hb ${val('vbg_hb')}\n`;
                }

                // IMMEDIATE MGMT
                t += `\nIMMEDIATE MANAGEMENT & IMAGING\n`;
                if(val('mgmt_analgesia')) t += `Analgesia: ${val('mgmt_analgesia')}\n`;
                if(val('mgmt_imaging')) t += `Imaging Requests: ${val('mgmt_imaging')}\n`;
                if(val('mgmt_referrals')) t += `Referrals/Int: ${val('mgmt_referrals')}\n`;
                
                // ADVANCED INTERVENTIONS
                const procs = [];
                if(chk('proc_rsi')) procs.push('RSI');
                if(chk('proc_artline')) procs.push('Arterial Line');
                if(chk('proc_thoracostomy')) procs.push('Finger Thoracostomy');
                if(chk('proc_chest_drain')) procs.push('Chest Drain');
                if(chk('proc_thoracotomy')) procs.push('Resus Thoracotomy');
                if(chk('proc_hysterotomy')) procs.push('Resus Hysterotomy');
                if(chk('proc_reboa')) procs.push('REBOA');
                
                if(procs.length > 0 || val('proc_notes')) {
                    t += `\nADVANCED INTERVENTIONS\n`;
                    if(procs.length) t += `Procedures: ${procs.join(', ')}\n`;
                    if(val('proc_notes')) t += `Notes: ${val('proc_notes')}\n`;
                }

                // PLAN
                t += `\nPLAN & DISPOSAL\n`;
                t += `Destination: ${val('destination')}\n`;
                t += `Plan: ${val('plan')}\n`;

                // SECONDARY SURVEY
                t += `\nSECONDARY SURVEY\n`;
                SECONDARY_ZONES.forEach(z => {
                    if(val(z.id)) t += `${z.label}: ${val(z.id)}\n`;
                });

                t += `\nPROBLEM LIST:\n${val('problemList')}\n`;
                
                t += `\nSigned: __________________________\n`;

                document.getElementById('finalOutput').value = t;
            }

            function copyToClipboard() {
                const el = document.getElementById('finalOutput');
                el.select();
                document.execCommand('copy'); // Fallback for older frames
                // Modern API
                if(navigator.clipboard) {
                    navigator.clipboard.writeText(el.value).then(() => {
                        const btn = document.getElementById('copyAll');
                        btn.textContent = 'COPIED!';
                        setTimeout(() => btn.textContent = 'COPY ALL', 2000);
                    });
                }
            }

            init();
        });
    </script>
</body>
</html>
