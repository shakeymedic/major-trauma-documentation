<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMEBEM Major Trauma Tool (Detailed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        html { scroll-behavior: smooth; }
        
        input, textarea, select { border-color: #94a3b8; }
        input:focus, textarea:focus, select:focus { border-color: #2563eb; ring: 2px; }

        /* --- BUTTON STYLES --- */
        .std-btn { transition: all 0.1s; border-color: #cbd5e1; background-color: #f8fafc; color: #334155; }
        .std-btn:hover { background-color: #e2e8f0; }
        .std-btn.active { background-color: #2563eb; color: white; border-color: #1d4ed8; font-weight: 800; }

        .lr-btn { transition: all 0.1s; }
        .lr-btn.active { background-color: #0284c7; color: white; font-weight: bold; border-color: #0284c7; }

        .injury-btn { transition: all 0.1s; background-color: white; border-color: #cbd5e1; color: #475569; }
        .injury-btn:hover { background-color: #fef2f2; }
        .injury-btn.active { background-color: #dc2626; color: white; border-color: #b91c1c; font-weight: bold; }

        .ph-btn { transition: all 0.1s; background-color: #f8fafc; border-color: #cbd5e1; color: #334155; }
        .ph-btn:hover { background-color: #ecfdf5; }
        .ph-btn.active { background-color: #059669; color: white; border-color: #047857; font-weight: 800; }

        .access-btn { transition: all 0.1s; background-color: white; border-color: #fecaca; color: #b91c1c; }
        .access-btn:hover { background-color: #fef2f2; }
        .access-btn.active { background-color: #dc2626; color: white; border-color: #991b1b; font-weight: 800; }
        
        .disp-btn { transition: all 0.1s; background-color: white; border-color: #c7d2fe; color: #4338ca; }
        .disp-btn:hover { background-color: #eef2ff; }
        .disp-btn.active { background-color: #4f46e5; color: white; border-color: #3730a3; font-weight: 800; }

        .toggle-radio:checked + div { background-color: #2563eb; color: white; border-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 antialiased pb-10">

    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-20 w-auto object-contain">
                <div>
                    <h1 class="text-xl md:text-2xl font-black text-slate-900 leading-tight">Major Trauma Tool</h1>
                    <p class="text-xs text-green-600 font-bold" id="saveStatus">Auto-save enabled</p>
                </div>
            </div>
            <nav class="hidden md:flex space-x-1 bg-slate-100 p-1 rounded-lg text-xs font-bold text-slate-600 border border-slate-300">
                <a href="#sec-primary" class="px-3 py-1 hover:bg-white rounded transition">Primary</a>
                <a href="#sec-mhp" class="px-3 py-1 hover:bg-white rounded transition">MHP</a>
                <a href="#sec-secondary" class="px-3 py-1 hover:bg-white rounded transition">Secondary</a>
                <button id="resetData" class="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded transition ml-2">Reset Form</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 xl:col-span-8 flex flex-col space-y-6">

                <button id="btn-arrival-now" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-black text-lg rounded-xl shadow-md border-2 border-blue-800 transition transform active:scale-[0.99] flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    SET PATIENT ARRIVAL TIME: NOW
                </button>

                <section class="bg-white p-5 rounded-xl shadow-sm border border-slate-400">
                    <h2 class="text-lg font-bold text-slate-900 mb-3">Specialty Attendance (Click on arrival)</h2>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="std-btn px-4 py-2 border-2 rounded-lg text-xs font-bold active:scale-95" data-spec="T&O">T&O</button>
                        <button type="button" class="std-btn px-4 py-2 border-2 rounded-lg text-xs font-bold active:scale-95" data-spec="Gen Surg">Gen Surg</button>
                        <button type="button" class="std-btn px-4 py-2 border-2 rounded-lg text-xs font-bold active:scale-95" data-spec="ICU/Anaesthetics">ICU/Anaes</button>
                        <button type="button" class="std-btn px-4 py-2 border-2 rounded-lg text-xs font-bold active:scale-95" data-spec="ED Consultant">ED Cons</button>
                    </div>
                    <textarea id="specialtyAttendances" rows="2" class="w-full px-3 py-2 bg-slate-50 border border-slate-400 rounded-md text-sm font-medium" placeholder="Other specialties or notes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border border-slate-400">
                    <h2 class="text-lg font-bold text-slate-900 mb-4 flex items-center">
                        <span class="w-1.5 h-6 bg-blue-600 mr-2 rounded-full"></span>ATMIST Handover
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Age</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="age" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-bold">
                                <label class="flex items-center space-x-1 text-xs font-bold text-slate-600 bg-slate-100 px-2 py-2 border border-slate-400 rounded-md cursor-pointer hover:bg-slate-200"><input type="checkbox" id="ageEstimated" class="rounded text-blue-600 border-slate-400"><span>Est.</span></label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Time of Incident</label>
                            <input type="time" id="timeOfIncident" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-bold">
                        </div>
                    </div>
                    <div class="space-y-3 mb-4">
                        <input type="text" id="mechanism" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Mechanism">
                        <input type="text" id="injuries" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Injuries Suspected">
                        <input type="text" id="signs" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Signs (Vitals)">
                    </div>

                    <div class="pt-4 border-t border-slate-200">
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-2">Pre-Hospital Treatments</label>
                        <div class="flex flex-wrap gap-2 mb-2" id="ph_treatments_btns">
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="IV Access">IV Access</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="Oxygen">Oxygen</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="Analgesia">Analgesia</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="TXA">TXA</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="Splinting">Splinting</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="Fluids">Fluids</button>
                            <button type="button" class="ph-btn px-3 py-2 border rounded text-xs font-bold" data-t="Blood">Blood</button>
                        </div>
                        <input type="text" id="ph_treatments_free" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium mb-3" placeholder="Other treatments / details...">

                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="preHospitalRSI" class="w-5 h-5 text-red-600 rounded border-gray-400 focus:ring-red-600">
                                <span class="font-bold text-red-900 text-sm">Pre-Hospital RSI Performed</span>
                            </label>
                            
                            <div id="rsiDetails" class="hidden mt-3 pt-3 border-t border-red-200 space-y-3">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="block text-xs font-bold text-red-800 uppercase">Tube Size</label><input type="text" id="rsi_size" class="w-full px-2 py-1 border border-red-300 rounded text-sm"></div>
                                    <div><label class="block text-xs font-bold text-red-800 uppercase">@ Teeth</label><input type="text" id="rsi_length" class="w-full px-2 py-1 border border-red-300 rounded text-sm"></div>
                                    <div><label class="block text-xs font-bold text-red-800 uppercase">Grade</label><select id="rsi_grade" class="w-full px-2 py-1 border border-red-300 rounded text-sm bg-white"><option></option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
                                    <div><label class="block text-xs font-bold text-red-800 uppercase">ETCO2</label><input type="text" id="rsi_etco2" class="w-full px-2 py-1 border border-red-300 rounded text-sm"></div>
                                </div>
                                <div><label class="block text-xs font-bold text-red-800 uppercase">Drugs</label><input type="text" id="rsi_drugs" class="w-full px-2 py-1 border border-red-300 rounded text-sm" placeholder="e.g. Ketamine / Rocuronium"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border border-slate-400">
                    <h2 class="text-lg font-bold text-slate-900 mb-4 flex items-center"><span class="w-1.5 h-6 bg-slate-400 mr-2 rounded-full"></span>Pre-Hospital / AMPLE</h2>
                    <textarea id="preHospitalOther" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm mb-4 font-medium" placeholder="Additional Pre-hospital notes..."></textarea>
                    <div class="grid grid-cols-1 gap-2 pt-2 border-t border-slate-200">
                        <div class="flex items-center gap-2"><span class="w-6 font-black text-slate-400 text-center">A</span><input type="text" id="history_a" class="flex-1 px-3 py-1.5 border border-slate-400 rounded text-sm font-medium" placeholder="Allergies"></div>
                        <div class="flex items-center gap-2"><span class="w-6 font-black text-slate-400 text-center">M</span><input type="text" id="history_m" class="flex-1 px-3 py-1.5 border border-slate-400 rounded text-sm font-medium" placeholder="Medications"></div>
                        <div class="flex items-center gap-2"><span class="w-6 font-black text-slate-400 text-center">P</span><input type="text" id="history_p" class="flex-1 px-3 py-1.5 border border-slate-400 rounded text-sm font-medium" placeholder="PMHx"></div>
                        <div class="flex items-center gap-2"><span class="w-6 font-black text-slate-400 text-center">L</span><input type="text" id="history_l" class="flex-1 px-3 py-1.5 border border-slate-400 rounded text-sm font-medium" placeholder="Last Meal"></div>
                        <div class="flex items-center gap-2"><span class="w-6 font-black text-slate-400 text-center">E</span><input type="text" id="history_e" class="flex-1 px-3 py-1.5 border border-slate-400 rounded text-sm font-medium" placeholder="Events"></div>
                    </div>
                </section>

                <div id="sec-primary" class="pt-2"><h2 class="text-3xl font-black text-slate-900 border-b-4 border-slate-900 pb-2">Primary Survey</h2></div>

                <section class="bg-white p-5 rounded-xl shadow-sm border-2 border-slate-300 border-l-[8px] border-l-blue-600">
                    <h3 class="text-2xl font-black text-blue-800 mb-4">A - Airway</h3>
                    
                    <div class="mb-4 space-y-3">
                        <div class="flex rounded-lg shadow-sm bg-slate-100 p-1 border border-slate-300">
                             <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airwayStatus" value="Patent" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-sm font-bold transition">Patent</div></label>
                             <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airwayStatus" value="Compromised" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-sm font-bold transition">Compromised</div></label>
                             <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airwayStatus" value="At Risk" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-sm font-bold transition">At Risk</div></label>
                        </div>

                        <div>
                            <span class="text-xs font-black text-slate-500 uppercase mb-1 block">Adjuncts</span>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="None">None</button>
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="OPA">OPA</button>
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="NPA">NPA</button>
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="iGel">iGel</button>
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="ETT">ETT</button>
                                <button type="button" class="std-btn px-3 py-2 border-2 rounded text-xs font-bold" data-adj="FONA">FONA</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-3">
                        <span class="text-xs font-black text-blue-900 uppercase block mb-2">C-Spine Protection</span>
                        <div class="flex gap-6">
                             <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="cspine_collar" class="w-5 h-5 text-blue-600 rounded border-blue-400"><span>Collar</span></label>
                             <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="cspine_blocks" class="w-5 h-5 text-blue-600 rounded border-blue-400"><span>Blocks</span></label>
                        </div>
                    </div>

                    <textarea id="airway_notes" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm" placeholder="Additional Airway Notes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border-2 border-slate-300 border-l-[8px] border-l-sky-400">
                    <h3 class="text-2xl font-black text-sky-700 mb-4">B - Breathing</h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 bg-slate-50 p-4 rounded-xl border border-slate-400">
                        <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">RR</label><input type="number" id="breathing_rr" class="w-full text-xl font-mono font-black px-2 py-2 border border-slate-400 rounded text-center focus:ring-sky-500"></div>
                        <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Sats (%)</label><input type="number" id="breathing_sats" class="w-full text-xl font-mono font-black px-2 py-2 border border-slate-400 rounded text-center focus:ring-sky-500"></div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Oxygen</label>
                            <div class="flex rounded-md shadow-sm w-full bg-white">
                                <label class="cursor-pointer flex-1"><input type="radio" name="breathing_o2" value="Air" checked class="sr-only toggle-radio peer"><div class="py-2.5 text-sm font-bold border border-slate-400 rounded-l text-center">Air</div></label>
                                <label class="cursor-pointer flex-1"><input type="radio" name="breathing_o2" value="O2" class="sr-only toggle-radio peer"><div class="py-2.5 text-sm font-bold border-y border-r border-slate-400 rounded-r text-center">Oxygen</div></label>
                            </div>
                        </div>
                    </div>
                    <div id="fio2_container" class="hidden mb-4"><input type="text" id="breathing_fio2" class="w-full px-3 py-2 border border-slate-400 rounded text-sm font-bold" placeholder="Flow Rate / FiO2 details"></div>

                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Findings</label>
                        <div id="breathing_findings" class="space-y-2"></div>
                    </div>
                    <textarea id="breathing_notes" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm" placeholder="Breathing Notes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border-2 border-slate-300 border-l-[8px] border-l-red-600">
                    <h3 class="text-2xl font-black text-red-700 mb-4">C - Circulation</h3>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-400 mb-4">
                        <div class="grid grid-cols-3 gap-4">
                            <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">HR</label><input type="number" id="circ_hr" class="w-full text-xl font-mono font-black px-2 py-2 border border-slate-400 rounded text-center focus:ring-red-500"></div>
                            <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">BP</label><input type="text" id="circ_bp" class="w-full text-xl font-mono font-black px-2 py-2 border border-slate-400 rounded text-center focus:ring-red-500"></div>
                            <div><label class="block text-xs font-bold text-slate-600 uppercase mb-1">CRT</label><input type="number" id="circ_capRefill" class="w-full text-xl font-mono font-black px-2 py-2 border border-slate-400 rounded text-center focus:ring-red-500"></div>
                        </div>
                    </div>

                    <section id="sec-mhp" class="bg-red-100 p-4 rounded-lg border-2 border-red-500 mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-2 gap-2">
                            <h2 class="text-lg font-black text-red-900">Major Haemorrhage Protocol</h2>
                            <div class="flex items-center gap-2">
                                <input type="time" id="mhp_time" class="px-2 py-1 border border-red-300 rounded text-sm font-bold text-red-900 bg-white hidden">
                                <label class="cursor-pointer flex items-center bg-white px-4 py-2 border-2 border-red-400 rounded shadow-sm hover:bg-red-50">
                                    <input type="checkbox" id="mhp_activated" class="w-6 h-6 text-red-600 rounded focus:ring-red-600">
                                    <span class="ml-2 font-black text-red-800">ACTIVATED</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-white border-l-[6px] border-red-600 p-3 mb-3 shadow-sm text-center">
                            <p class="font-black text-red-600 text-sm">⚠️ PROMPT: GIVE TRANEXAMIC ACID & CALCIUM ⚠️</p>
                        </div>
                        <div id="mhpDetails" class="hidden space-y-3">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div><label class="block text-[10px] font-bold text-red-900 uppercase mb-1">PRBC (Units)</label><input type="number" id="mhp_prbc" class="w-full px-2 py-1 border border-red-400 rounded text-center font-mono font-black" placeholder="0"></div>
                                <div><label class="block text-[10px] font-bold text-red-900 uppercase mb-1">FFP</label><input type="number" id="mhp_ffp" class="w-full px-2 py-1 border border-red-400 rounded text-center font-mono font-black" placeholder="0"></div>
                                <div><label class="block text-[10px] font-bold text-red-900 uppercase mb-1">Platelets</label><input type="number" id="mhp_plt" class="w-full px-2 py-1 border border-red-400 rounded text-center font-mono font-black" placeholder="0"></div>
                                <div><label class="block text-[10px] font-bold text-red-900 uppercase mb-1">Cryo</label><input type="number" id="mhp_cryo" class="w-full px-2 py-1 border border-red-400 rounded text-center font-mono font-black" placeholder="0"></div>
                            </div>
                        </div>
                    </section>

                    <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-400">
                        <span class="block text-sm font-bold text-slate-800 mb-3 border-b border-slate-300 pb-1">Lines & Access (Select all that apply)</span>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            <div>
                                <span class="text-xs font-black text-slate-500 uppercase">Left Arm</span>
                                <div class="flex gap-2 mt-1">
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-blue-600" value="IV (L Arm)"><span>IV</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-yellow-600" value="Art (L Arm)"><span>Art</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-red-600" value="IO (L Arm)"><span>IO</span></label>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs font-black text-slate-500 uppercase">Right Arm</span>
                                <div class="flex gap-2 mt-1">
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-blue-600" value="IV (R Arm)"><span>IV</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-yellow-600" value="Art (R Arm)"><span>Art</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-red-600" value="IO (R Arm)"><span>IO</span></label>
                                </div>
                            </div>
                             <div>
                                <span class="text-xs font-black text-slate-500 uppercase">Neck / Central</span>
                                <div class="flex flex-col gap-1 mt-1">
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-green-600" value="CVC (IJ)"><span>IJ CVC</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-green-600" value="CVC (Subclav)"><span>Subclavian CVC</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-blue-600" value="RIC (Neck)"><span>RIC</span></label>
                                </div>
                            </div>
                             <div>
                                <span class="text-xs font-black text-slate-500 uppercase">Groin / Legs</span>
                                <div class="flex gap-2 mt-1">
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-blue-600" value="Femoral CVC"><span>Fem CVC</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-yellow-600" value="Femoral Art"><span>Fem Art</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" class="access-chk rounded text-red-600" value="IO (Leg)"><span>IO</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <span class="block text-sm font-bold text-slate-700 mb-2">Sites of Bleeding / Injury</span>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2" id="injury_grid">
                            </div>
                    </div>

                    <div class="mb-4">
                        <span class="text-xs font-bold text-slate-500 uppercase">Haemorrhage Control</span>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button type="button" class="access-btn px-4 py-2 border-2 rounded text-xs font-bold" data-text="Pelvic Binder applied">Pelvic Binder</button>
                            <button type="button" class="access-btn px-4 py-2 border-2 rounded text-xs font-bold" data-text="KTD Splint applied">KTD</button>
                            <button type="button" class="access-btn px-4 py-2 border-2 rounded text-xs font-bold" data-text="Tourniquet applied">Tourniquet</button>
                        </div>
                    </div>

                    <div class="bg-red-50 p-3 rounded border-2 border-red-200 mb-3">
                         <span class="block text-xs font-bold text-red-800 uppercase mb-2">TXA Given</span>
                         <div class="flex gap-6">
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="txaGiven" value="None" checked class="text-red-600 focus:ring-red-500 w-5 h-5"><span>None</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="txaGiven" value="1g" class="text-red-600 focus:ring-red-500 w-5 h-5"><span>1g</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="txaGiven" value="2g" class="text-red-600 focus:ring-red-500 w-5 h-5"><span>2g</span></label>
                         </div>
                    </div>
                    
                    <textarea id="circ_notes" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Circulation Notes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border-2 border-slate-300 border-l-[8px] border-l-yellow-400">
                    <h3 class="text-2xl font-black text-yellow-700 mb-4">D - Disability</h3>
                    
                    <div class="mb-4">
                        <label class="flex items-center space-x-2 p-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg w-full mb-4 cursor-pointer hover:bg-yellow-100">
                            <input type="checkbox" id="headInjury" class="w-5 h-5 text-yellow-600 rounded border-gray-400 focus:ring-yellow-500">
                            <span class="font-bold text-yellow-900">Head Injury Suspected</span>
                        </label>
                        
                        <div class="flex rounded-lg shadow-sm bg-slate-100 p-1 mb-4 border border-slate-300">
                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="disability_avpu" value="Alert" checked class="sr-only toggle-radio peer"><div class="px-2 py-3 text-sm font-bold rounded transition">A</div></label>
                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="disability_avpu" value="Voice" class="sr-only toggle-radio peer"><div class="px-2 py-3 text-sm font-bold rounded transition">V</div></label>
                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="disability_avpu" value="Pain" class="sr-only toggle-radio peer"><div class="px-2 py-3 text-sm font-bold rounded transition">P</div></label>
                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="disability_avpu" value="Unresponsive" class="sr-only toggle-radio peer"><div class="px-2 py-3 text-sm font-bold rounded transition">U</div></label>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                         <div><label class="block text-xs font-bold text-slate-600 mb-1">Eyes</label><select id="disability_gcsE" class="w-full text-sm border-slate-400 rounded bg-white py-2 font-medium"></select></div>
                         <div><label class="block text-xs font-bold text-slate-600 mb-1">Verbal</label><select id="disability_gcsV" class="w-full text-sm border-slate-400 rounded bg-white py-2 font-medium"></select></div>
                         <div><label class="block text-xs font-bold text-slate-600 mb-1">Motor</label><select id="disability_gcsM" class="w-full text-sm border-slate-400 rounded bg-white py-2 font-medium"></select></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <div><label class="block text-xs font-black text-slate-600 uppercase mb-1">L Pupil</label><input type="text" id="disability_pupil_left" class="w-full px-2 py-2 border border-slate-400 rounded text-sm" placeholder="e.g. 3mm"></div>
                        <div><label class="block text-xs font-black text-slate-600 uppercase mb-1">R Pupil</label><input type="text" id="disability_pupil_right" class="w-full px-2 py-2 border border-slate-400 rounded text-sm" placeholder="e.g. 3mm"></div>
                        <div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Glucose</label><input type="number" id="disability_glucose" class="w-full px-2 py-2 border border-slate-400 rounded text-sm" placeholder="mmol/L"></div>
                    </div>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border-2 border-slate-300 border-l-[8px] border-l-green-500">
                    <h3 class="text-2xl font-black text-green-700 mb-3">E - Exposure</h3>
                    <div class="w-1/3 mb-3"><label class="block text-xs font-bold text-slate-600 uppercase mb-1">Temp</label><input type="number" id="exposure_temp" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-bold"></div>
                    <textarea id="exposure_notes" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Exposure notes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-xl shadow-sm border border-slate-400">
                    <h2 class="text-lg font-bold text-slate-900 mb-4">Investigations & Plan</h2>
                    
                    <div class="bg-slate-700 p-4 rounded-xl shadow-inner mb-4 text-white">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-black text-slate-200 uppercase">Blood Gas Results (Initial)</h4>
                            <div class="flex bg-slate-800 rounded p-1 border border-slate-600">
                                <label class="cursor-pointer px-3 py-1"><input type="radio" name="gasType" value="VBG" checked class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-white peer-checked:underline">VBG</span></label>
                                <label class="cursor-pointer px-3 py-1"><input type="radio" name="gasType" value="ABG" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-white peer-checked:underline">ABG</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                            <div><label class="block text-[10px] uppercase text-slate-400">pH</label><input type="number" id="vbgInitial_ph" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">pCO2</label><input type="number" id="vbgInitial_pco2" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">pO2</label><input type="number" id="vbgInitial_po2" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">HCO3</label><input type="number" id="vbgInitial_hco3" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">BE</label><input type="number" id="vbgInitial_be" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">Lac</label><input type="number" id="vbgInitial_lactate" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-400">Ca++</label><input type="number" id="vbgInitial_ionisedCa" class="w-full px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold"></div>
                        </div>
                        <div id="gasFio2Container" class="hidden mt-3 pt-2 border-t border-slate-600">
                             <label class="block text-[10px] uppercase text-slate-400 mb-1">ABG FiO2 (%)</label>
                             <input type="number" id="gasFio2" class="w-24 px-1 py-1 text-sm bg-slate-600 border-slate-500 rounded text-white font-bold">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div><label class="block text-sm font-bold mb-1">Imaging Decisions</label><textarea id="imagingDecisions" rows="2" class="w-full px-3 py-2 border border-slate-400 rounded text-sm font-medium"></textarea></div>
                    </div>
                </section>

                <section id="sec-secondary" class="bg-white p-5 rounded-xl shadow-sm border border-slate-400">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 pb-2 border-b border-slate-300">Secondary Survey</h2>
                    
                    <div class="bg-slate-100 p-4 rounded-xl border border-slate-300 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-black text-slate-700 uppercase">Repeat Blood Gas</h4>
                            <div class="flex bg-white rounded p-1 border border-slate-300">
                                <label class="cursor-pointer px-3 py-1"><input type="radio" name="secGasType" value="VBG" checked class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-blue-600 peer-checked:underline">VBG</span></label>
                                <label class="cursor-pointer px-3 py-1"><input type="radio" name="secGasType" value="ABG" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-blue-600 peer-checked:underline">ABG</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                            <div><label class="block text-[10px] uppercase text-slate-500">pH</label><input type="number" id="vbgSec_ph" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">pCO2</label><input type="number" id="vbgSec_pco2" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">pO2</label><input type="number" id="vbgSec_po2" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">HCO3</label><input type="number" id="vbgSec_hco3" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">BE</label><input type="number" id="vbgSec_be" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">Lac</label><input type="number" id="vbgSec_lactate" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                            <div><label class="block text-[10px] uppercase text-slate-500">Ca++</label><input type="number" id="vbgSec_ionisedCa" class="w-full px-1 py-1 text-sm bg-white border-slate-300 rounded text-slate-900 font-bold"></div>
                        </div>
                    </div>

                    <div id="secondary_container" class="space-y-4"></div>
                    
                    <div class="mt-8 pt-4 border-t-2 border-slate-300">
                        <h3 class="text-base font-black text-slate-800 uppercase mb-4">Detailed Neurological Examination</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded border border-slate-300">
                                <span class="block text-xs font-black text-slate-500 uppercase mb-2 border-b border-slate-200 pb-1">Upper Limbs</span>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-bold text-slate-600 text-center block uppercase">Left</span>
                                        <select id="neuro_pul" class="neuro-select w-full text-xs font-bold border-slate-300 rounded"></select>
                                        <select id="neuro_sul" class="neuro-select w-full text-xs font-medium border-slate-300 rounded"></select>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-bold text-slate-600 text-center block uppercase">Right</span>
                                        <select id="neuro_pur" class="neuro-select w-full text-xs font-bold border-slate-300 rounded"></select>
                                        <select id="neuro_sur" class="neuro-select w-full text-xs font-medium border-slate-300 rounded"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded border border-slate-300">
                                <span class="block text-xs font-black text-slate-500 uppercase mb-2 border-b border-slate-200 pb-1">Lower Limbs</span>
                                 <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-bold text-slate-600 text-center block uppercase">Left</span>
                                        <select id="neuro_pll" class="neuro-select w-full text-xs font-bold border-slate-300 rounded"></select>
                                        <select id="neuro_sll" class="neuro-select w-full text-xs font-medium border-slate-300 rounded"></select>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-bold text-slate-600 text-center block uppercase">Right</span>
                                        <select id="neuro_plr" class="neuro-select w-full text-xs font-bold border-slate-300 rounded"></select>
                                        <select id="neuro_slr" class="neuro-select w-full text-xs font-medium border-slate-300 rounded"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="bg-indigo-50 p-5 rounded-xl shadow-sm border border-indigo-200">
                    <h2 class="text-xl font-bold text-indigo-900 mb-4">Post-Secondary & Plan</h2>
                    
                    <div class="mb-5 bg-white p-4 rounded-lg border border-indigo-200">
                        <label class="flex items-center space-x-2 cursor-pointer mb-2">
                             <input type="checkbox" id="furtherImaging" class="w-5 h-5 text-indigo-600 rounded">
                             <span class="font-bold text-indigo-900">Further Imaging Required</span>
                        </label>
                        <input type="text" id="furtherImagingDetails" class="w-full px-3 py-2 border border-indigo-200 rounded text-sm hidden" placeholder="Details of imaging...">
                    </div>

                    <p class="text-xs font-black text-indigo-700 uppercase mb-2">Time Critical Meds (RCEM List) - PRESCRIBED?</p>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-5">
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Parkinsons Meds"><span>Parkinson's (Levodopa)</span></label>
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Insulin"><span>Insulin</span></label>
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Anti-Epileptics"><span>Anti-Epileptics</span></label>
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Steroids"><span>Steroids</span></label>
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Anticoagulants"><span>Anticoagulants</span></label>
                        <label class="flex items-center space-x-2 p-2 bg-white rounded border border-indigo-200 cursor-pointer"><input type="checkbox" class="med-check rounded text-indigo-600" value="Antibiotics"><span>Antibiotics (Sepsis/Open #)</span></label>
                    </div>

                    <p class="text-xs font-black text-indigo-700 uppercase mb-2">Disposition</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="Theatre">Theatre</button>
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="ICU">ICU</button>
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="Ward">Ward</button>
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="Transfer">Transfer</button>
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="Discharge">Discharge</button>
                         <button class="disp-btn px-4 py-2 border rounded text-xs font-bold" data-val="Mortuary">Mortuary</button>
                    </div>

                    <textarea id="definitivePlan" rows="3" class="w-full px-3 py-2 border border-indigo-300 rounded-md text-sm bg-white font-medium" placeholder="Definitive Plan notes..."></textarea>
                </section>
                
                 <section class="bg-slate-800 p-5 rounded-xl shadow-md text-white">
                    <h2 class="text-lg font-bold mb-3">Problem List / Impression</h2>
                    <textarea id="problemList" rows="5" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm text-white placeholder-slate-400"></textarea>
                </section>

                <footer class="mt-8 py-8 text-center border-t border-slate-300">
                    <p class="text-xs text-slate-500 font-bold mb-1">&copy; West Midlands Evidence Based Emergency Medicine Ltd.</p>
                    <p class="text-xs text-slate-400">Author: Dr Jake Turner</p>
                </footer>
            </div>

            <div class="lg:col-span-5 xl:col-span-4 relative">
                <div class="sticky top-24 space-y-6">
                    <section class="bg-white p-4 rounded-xl shadow-lg border border-slate-300">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Initial Note</h2>
                            <button id="copyInitial" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition">Copy</button>
                        </div>
                        <textarea readonly id="initialNoteOutput" class="w-full h-96 p-3 bg-slate-50 border border-slate-300 rounded-md text-xs font-mono text-slate-700 whitespace-pre-wrap focus:outline-none resize-none"></textarea>
                    </section>
                    
                    <section class="bg-white p-4 rounded-xl shadow-lg border border-slate-300">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Secondary Survey Note</h2>
                            <button id="copySecondary" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition">Copy</button>
                        </div>
                        <textarea readonly id="secondaryNoteOutput" class="w-full h-80 p-3 bg-slate-50 border border-slate-300 rounded-md text-xs font-mono text-slate-700 whitespace-pre-wrap focus:outline-none resize-none"></textarea>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            // Updated specialties to array of objects {name, time}
            let patientData = {
                arrival: { time: '', specialties: [], specialtiesNotes: '' },
                atmist: { age: '', ageEst: false, time: '', mech: '', inj: '', signs: '', phTreatments: [], phNotes: '' },
                prehosp: { notes: '', history: {a:'', m:'', p:'', l:'', e:''} },
                airway: { status: 'Patent', rsi: false, rsiData: {size:'', length:'', grade:'', etco2:'', drugs:''}, adjuncts: [], collar: false, blocks: false, notes: '' },
                breathing: { rr: '', sats: '', o2: 'Air', fio2: '', findings: [], notes: '' },
                circulation: { hr: '', bp: '', crt: '', lines: [], bleeding: [], txa: 'None', binder: false, ktd: false, tourniquet: false, notes: '' },
                mhp: { activated: false, time: '', prbc: '', ffp: '', plt: '', cryo: '' },
                disability: { avpu: 'Alert', headInjury: false, gcsE: 4, gcsV: 5, gcsM: 6, pupilL: '', pupilR: '', glucose: '' },
                exposure: { temp: '', notes: '' },
                investigations: { 
                    gasType: 'VBG', vbg: {ph:'', pco2:'', po2:'', hco3:'', be:'', lac:'', ca:'', abgFio2:''}, 
                    secGasType: 'VBG', vbgSec: {ph:'', pco2:'', po2:'', hco3:'', be:'', lac:'', ca:''},
                    imaging: '' 
                },
                secondary: {},
                neuroExam: { pul: '5/5', sul: 'Intact', pur: '5/5', sur: 'Intact', pll: '5/5', sll: 'Intact', plr: '5/5', slr: 'Intact' },
                definitive: { furtherImaging: false, furtherImagingDetails: '', meds: [], disposition: '', plan: '' },
                problemList: ''
            };

            const SS_AREAS = [
                { id: 'head', label: 'Head', tags: ['Normocephalic', 'Laceration', 'Haematoma', 'Bony Tenderness'] },
                { id: 'face', label: 'Face', tags: ['Symmetrical', 'Laceration', 'Bony Tenderness', 'Le Fort instability'] },
                { id: 'eyes', label: 'Eyes', tags: ['PERLA', 'EOMI', 'Racoon Eyes', 'Subconj. Haem'] },
                { id: 'neck', label: 'Neck', tags: ['Trachea Central', 'Non-tender', 'Deformity', 'Steps'] },
                { id: 'chest', label: 'Chest', tags: ['Expansion Eq.', 'Non-tender', 'Crepitus', 'Bruising'] },
                { id: 'abdo', label: 'Abdomen', tags: ['Soft', 'Non-tender', 'Distended', 'Seatbelt Sign', 'Guarding'] },
                { id: 'pelvis', label: 'Pelvis', tags: ['Stable', 'Non-tender', 'Unstable', 'Bruising'] },
                { id: 'back', label: 'Back', tags: ['No steps', 'Non-tender', 'Step deformity', 'Bruising'] },
                { id: 'limbs', label: 'Limbs', tags: ['Move 4 limbs', 'Neuro Intact', 'Deformity', 'Fracture Suspected'] }
            ];

            const BREATHING_OPTS = ['Chest Wall Injury', 'Sucking Chest Wound', 'Flail Segment', 'Surgical Emphysema', 'Crepitus', 'Bruising', 'Deformity', 'Reduced Expansion'];
            const INJURY_SITES = ['Scalp', 'Face', 'Chest', 'Abdomen', 'Pelvis', 'L Arm', 'R Arm', 'L Leg', 'R Leg', 'Back'];

            // --- UI HELPERS ---
            const getEl = (id) => document.getElementById(id);
            const getTime = () => new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            // --- LOCAL STORAGE & RESTORE ---
            function saveState() {
                localStorage.setItem('wmebem_trauma_data', JSON.stringify(patientData));
            }

            function loadState() {
                const saved = localStorage.getItem('wmebem_trauma_data');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        patientData = { ...patientData, ...parsed };
                        restoreUI();
                    } catch (e) {
                        console.error("Error loading save data", e);
                    }
                }
            }

            function restoreUI() {
                const p = patientData;
                const setVal = (id, val) => { const el = getEl(id); if(el) el.value = val || ''; };
                const setCheck = (id, val) => { const el = getEl(id); if(el) el.checked = !!val; };

                // Specialties (Array of Objects now)
                if(Array.isArray(p.arrival.specialties)) {
                    p.arrival.specialties.forEach(s => {
                        // Handle both old string format and new object format for backward compatibility
                        const name = typeof s === 'string' ? s : s.name;
                        const btn = document.querySelector(`.std-btn[data-spec="${name}"]`);
                        if(btn) btn.classList.add('active');
                    });
                }
                setVal('specialtyAttendances', p.arrival.specialtiesNotes);

                setVal('age', p.atmist.age);
                setCheck('ageEstimated', p.atmist.ageEst);
                setVal('timeOfIncident', p.atmist.time);
                setVal('mechanism', p.atmist.mech);
                setVal('injuries', p.atmist.inj);
                setVal('signs', p.atmist.signs);
                
                p.atmist.phTreatments.forEach(t => {
                    const btn = document.querySelector(`.ph-btn[data-t="${t}"]`);
                    if(btn) btn.classList.add('active');
                });
                setVal('ph_treatments_free', p.atmist.phNotes);
                
                setVal('preHospitalOther', p.prehosp.notes);
                ['a','m','p','l','e'].forEach(k => setVal(`history_${k}`, p.prehosp.history[k]));
                
                setCheck('preHospitalRSI', p.airway.rsi);
                if(p.airway.rsi) getEl('rsiDetails').classList.remove('hidden');
                ['size','length','grade','etco2','drugs'].forEach(k => setVal(`rsi_${k}`, p.airway.rsiData[k]));
                
                if(p.airway.status) {
                    const r = document.querySelector(`input[name="airwayStatus"][value="${p.airway.status}"]`);
                    if(r) r.checked = true;
                }
                p.airway.adjuncts.forEach(a => {
                    const btn = document.querySelector(`.std-btn[data-adj="${a}"]`);
                    if(btn) btn.classList.add('active');
                });
                setCheck('cspine_collar', p.airway.collar);
                setCheck('cspine_blocks', p.airway.blocks);
                setVal('airway_notes', p.airway.notes);

                setVal('breathing_rr', p.breathing.rr);
                setVal('breathing_sats', p.breathing.sats);
                if(p.breathing.o2) {
                    const r = document.querySelector(`input[name="breathing_o2"][value="${p.breathing.o2}"]`);
                    if(r) r.checked = true;
                    if(p.breathing.o2 === 'O2') getEl('fio2_container').classList.remove('hidden');
                }
                setVal('breathing_fio2', p.breathing.fio2);
                setVal('breathing_notes', p.breathing.notes);
                
                setVal('circ_hr', p.circulation.hr);
                setVal('circ_bp', p.circulation.bp);
                setVal('circ_capRefill', p.circulation.crt);
                setVal('circ_notes', p.circulation.notes);
                if(p.circulation.txa) {
                     const r = document.querySelector(`input[name="txaGiven"][value="${p.circulation.txa}"]`);
                     if(r) r.checked = true;
                }
                
                p.circulation.lines.forEach(l => {
                    const chk = document.querySelector(`.access-chk[value="${l}"]`);
                    if(chk) chk.checked = true;
                });
                
                if(p.circulation.binder) document.querySelector('[data-text*="Binder"]').classList.add('active');
                if(p.circulation.ktd) document.querySelector('[data-text*="KTD"]').classList.add('active');
                if(p.circulation.tourniquet) document.querySelector('[data-text*="Tourniquet"]').classList.add('active');

                setCheck('mhp_activated', p.mhp.activated);
                if(p.mhp.activated) {
                    getEl('mhpDetails').classList.remove('hidden');
                    getEl('mhp_time').classList.remove('hidden');
                }
                setVal('mhp_time', p.mhp.time);
                ['prbc','ffp','plt','cryo'].forEach(k => setVal(`mhp_${k}`, p.mhp[k]));

                setCheck('headInjury', p.disability.headInjury);
                if(p.disability.avpu) {
                    const r = document.querySelector(`input[name="disability_avpu"][value="${p.disability.avpu}"]`);
                    if(r) r.checked = true;
                }
                
                setVal('disability_pupil_left', p.disability.pupilL);
                setVal('disability_pupil_right', p.disability.pupilR);
                setVal('disability_glucose', p.disability.glucose);

                setVal('exposure_temp', p.exposure.temp);
                setVal('exposure_notes', p.exposure.notes);

                const rGas = document.querySelector(`input[name="gasType"][value="${p.investigations.gasType}"]`);
                if(rGas) rGas.checked = true;
                if(p.investigations.gasType === 'ABG') getEl('gasFio2Container').classList.remove('hidden');

                const rSecGas = document.querySelector(`input[name="secGasType"][value="${p.investigations.secGasType}"]`);
                if(rSecGas) rSecGas.checked = true;

                ['ph','pco2','po2','hco3','be','lac','ca','abgFio2'].forEach(k => {
                    const map = {lac:'lactate', ca:'ionisedCa'};
                    const idKey = map[k] || k;
                    setVal(`vbgInitial_${idKey}`, p.investigations.vbg[k]);
                });
                
                ['ph','pco2','po2','hco3','be','lac','ca'].forEach(k => {
                     const map = {lac:'lactate', ca:'ionisedCa'};
                     const idKey = map[k] || k;
                     setVal(`vbgSec_${idKey}`, p.investigations.vbgSec[k]);
                });
                
                setVal('imagingDecisions', p.investigations.imaging);
                
                setCheck('furtherImaging', p.definitive.furtherImaging);
                if(p.definitive.furtherImaging) getEl('furtherImagingDetails').classList.remove('hidden');
                setVal('furtherImagingDetails', p.definitive.furtherImagingDetails);
                
                p.definitive.meds.forEach(m => {
                    const chk = document.querySelector(`.med-check[value="${m}"]`);
                    if(chk) chk.checked = true;
                });
                
                if(p.definitive.disposition) {
                    const btn = document.querySelector(`.disp-btn[data-val="${p.definitive.disposition}"]`);
                    if(btn) btn.classList.add('active');
                }
                setVal('definitivePlan', p.definitive.plan);
                setVal('problemList', p.problemList);
            }

            // --- BUILD UI ---
            const bContainer = getEl('breathing_findings');
            BREATHING_OPTS.forEach(opt => {
                bContainer.innerHTML += `
                    <div class="flex items-center justify-between bg-slate-50 border border-slate-300 rounded-lg p-2">
                        <span class="text-sm font-bold text-slate-700">${opt}</span>
                        <div class="flex gap-2">
                            <button class="lr-btn w-12 h-10 rounded-md border-2 border-slate-300 bg-white font-black text-slate-600 hover:bg-slate-100" data-f="${opt}" data-s="L">L</button>
                            <button class="lr-btn w-12 h-10 rounded-md border-2 border-slate-300 bg-white font-black text-slate-600 hover:bg-slate-100" data-f="${opt}" data-s="R">R</button>
                        </div>
                    </div>
                `;
            });
            bContainer.addEventListener('click', e => {
                if(e.target.classList.contains('lr-btn')) {
                    e.preventDefault();
                    e.target.classList.toggle('active');
                    const { f, s } = e.target.dataset;
                    const exists = patientData.breathing.findings.find(x => x.f === f && x.s === s);
                    if(exists) patientData.breathing.findings = patientData.breathing.findings.filter(x => !(x.f===f && x.s===s));
                    else patientData.breathing.findings.push({f,s});
                    updateNotes();
                }
            });

            const injContainer = getEl('injury_grid');
            INJURY_SITES.forEach(site => {
                injContainer.innerHTML += `<button class="injury-btn py-2 border-2 rounded-md text-xs font-bold" data-site="${site}">${site}</button>`;
            });
            injContainer.addEventListener('click', e => {
                if(e.target.classList.contains('injury-btn')) {
                    e.target.classList.toggle('active');
                    const site = e.target.dataset.site;
                    if(patientData.circulation.bleeding.includes(site)) patientData.circulation.bleeding = patientData.circulation.bleeding.filter(x => x !== site);
                    else patientData.circulation.bleeding.push(site);
                    updateNotes();
                }
            });

            document.querySelectorAll('.disp-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.disp-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    patientData.definitive.disposition = e.target.dataset.val;
                    updateNotes();
                });
            });

            const secContainer = getEl('secondary_container');
            SS_AREAS.forEach(area => {
                const div = document.createElement('div');
                div.className = "mb-4 pb-4 border-b border-slate-300 last:border-0";
                let tagsHtml = `<div class="flex flex-wrap gap-2 mb-2">`;
                area.tags.forEach(tag => {
                    tagsHtml += `<label class="cursor-pointer"><input type="checkbox" class="tag-checkbox hidden" data-area="${area.id}" value="${tag}"><span class="px-2 py-1 text-xs border-2 border-slate-300 rounded hover:bg-slate-50 transition select-none font-bold text-slate-600">${tag}</span></label>`;
                });
                tagsHtml += `</div>`;
                div.innerHTML = `
                    <label class="block text-xs font-black text-slate-600 uppercase mb-1">${area.label}</label>
                    ${tagsHtml}
                    <textarea id="ss_${area.id}" rows="1" class="w-full px-3 py-2 border border-slate-400 rounded text-sm font-medium" placeholder="Details..."></textarea>
                `;
                secContainer.appendChild(div);
                if(!patientData.secondary[area.id]) patientData.secondary[area.id] = { tags: [], text: '' };
            });

            const powerOpts = ['5/5', '4/5', '3/5', '2/5', '1/5', '0/5'];
            const sensOpts = ['Intact', 'Reduced', 'Absent', 'Paraesthesia'];
            document.querySelectorAll('.neuro-select').forEach(sel => {
                const isPower = sel.id.includes('neuro_p');
                const opts = isPower ? powerOpts : sensOpts;
                const def = isPower ? '5/5' : 'Intact';
                opts.forEach(o => {
                    sel.add(new Option(isPower ? `Power ${o}` : o, o));
                });
                sel.value = def;
                sel.addEventListener('change', e => {
                   patientData.neuroExam[sel.id.replace('neuro_', '')] = e.target.value;
                   updateNotes();
                });
            });
            
            const popSel = (id, opts, def) => { const s=getEl(id); opts.forEach(o=>s.add(new Option(o,o))); s.value=def; s.addEventListener('change',e=>{patientData.disability[id.split('_')[1]]=e.target.value; updateNotes();})};
            popSel('disability_gcsE', [4,3,2,1], 4);
            popSel('disability_gcsV', [5,4,3,2,1], 5);
            popSel('disability_gcsM', [6,5,4,3,2,1], 6);

            // --- NOTE GENERATION ---
            function updateNotes() {
                const p = patientData;
                let t = `**Major Trauma Assessment**\n`;
                if(p.arrival.time) t += `Patient Arrival Time: ${p.arrival.time}\n`;
                
                // Specialties with Time
                let specs = p.arrival.specialties.map(s => {
                    // Handle old string format if local storage has old data
                    if(typeof s === 'string') return s;
                    return `${s.name} (@ ${s.time})`;
                });
                if(p.arrival.specialtiesNotes) specs.push(p.arrival.specialtiesNotes);
                if(specs.length) t += `Specialties Present: ${specs.join(', ')}\n`;
                
                t += `\n**ATMIST**\nAge: ${p.atmist.age}${p.atmist.ageEst?'(Est)':''} | Time: ${p.atmist.time}\nMech: ${p.atmist.mech}\nInj: ${p.atmist.inj}\nSigns: ${p.atmist.signs}\n`;
                
                let phArr = [...p.atmist.phTreatments];
                if(p.atmist.phNotes) phArr.push(p.atmist.phNotes);
                if(phArr.length > 0) t += `Pre-Hosp Tx: ${phArr.join(', ')}\n`;

                if(p.prehosp.notes) t+= `Pre-Hospital Notes: ${p.prehosp.notes}\n`;
                t += `AMPLE: A:${p.prehosp.history.a} M:${p.prehosp.history.m} P:${p.prehosp.history.p} L:${p.prehosp.history.l} E:${p.prehosp.history.e}\n`;

                t += `\n**PRIMARY SURVEY**\n`;
                
                t += `A: ${p.airway.status}. `;
                if(p.airway.adjuncts.length) t += `Adjuncts: ${p.airway.adjuncts.join(', ')}. `;
                if (p.airway.rsi) {
                    t += `Pre-Hosp RSI: Size ${p.airway.rsiData.size}, Length ${p.airway.rsiData.length}cm, Grade ${p.airway.rsiData.grade}, ETCO2 ${p.airway.rsiData.etco2}. Drugs: ${p.airway.rsiData.drugs}. `;
                }
                t += `C-Spine: ${p.airway.collar?'Collar ':''}${p.airway.blocks?'Blocks':''}. ${p.airway.notes}\n`;
                
                // Detailed Breathing with Negatives
                let o2 = p.breathing.o2 === 'Air' ? 'Air' : `O2 ${p.breathing.fio2}`;
                t += `B: RR ${p.breathing.rr} Sats ${p.breathing.sats}% (${o2}).\n   Positive Findings: ${p.breathing.findings.length ? p.breathing.findings.map(f=>`${f.f}(${f.s})`).join(', ') : 'None'}.`;
                
                // Calculate Negatives
                const currentBFindings = p.breathing.findings.map(f => f.f);
                const negB = BREATHING_OPTS.filter(opt => !currentBFindings.includes(opt));
                if (negB.length > 0) {
                    // Check if air entry seems normal (no expansion issues)
                    const airEntryNormal = !currentBFindings.includes('Reduced Expansion');
                    t += `\n   Checked/Normal: ${airEntryNormal ? "Air entry equal and clear. " : ""}No ${negB.join(', ').toLowerCase()}.`;
                }
                t += ` ${p.breathing.notes}\n`;
                
                // Detailed Circulation with Negatives
                t += `C: HR ${p.circulation.hr} BP ${p.circulation.bp} CRT ${p.circulation.crt}. TXA: ${p.circulation.txa}.\n`;
                if(p.circulation.lines.length) t += `   Access: ${p.circulation.lines.join(', ')}\n`;
                
                // Injury Sites
                if(p.circulation.bleeding.length) t += `   Injuries/Bleeding Identified: ${p.circulation.bleeding.join(', ')}\n`;
                // Calculate Negative Sites
                const negSites = INJURY_SITES.filter(s => !p.circulation.bleeding.includes(s));
                if(negSites.length > 0) {
                     t += `   No obvious external injury/bleeding to: ${negSites.join(', ')}\n`;
                }
                
                let interventions = [];
                if(p.circulation.binder) interventions.push("Binder");
                if(p.circulation.ktd) interventions.push("KTD");
                if(p.circulation.tourniquet) interventions.push("Tourniquet");
                if(interventions.length) t += `   Interventions: ${interventions.join(', ')}\n`;
                t += `   ${p.circulation.notes}\n`;

                if(p.mhp.activated) {
                    t += `**MHP ACTIVATED** (${p.mhp.time || 'Time Not Set'})\nGiven: PRBC ${p.mhp.prbc || 0}, FFP ${p.mhp.ffp || 0}, Plt ${p.mhp.plt || 0}, Cryo ${p.mhp.cryo || 0}.\n`;
                }

                let gcsTot = parseInt(p.disability.gcsE) + parseInt(p.disability.gcsV) + parseInt(p.disability.gcsM);
                t += `D: AVPU ${p.disability.avpu}. GCS ${gcsTot} (E${p.disability.gcsE}V${p.disability.gcsV}M${p.disability.gcsM}). Pupils: L ${p.disability.pupilL} R ${p.disability.pupilR}. BMs ${p.disability.glucose}. ${p.disability.headInjury ? '**Head Injury Suspected**' : ''}\n`;
                
                t += `E: Temp ${p.exposure.temp}. ${p.exposure.notes}\n`;
                
                const v = p.investigations.vbg;
                t += `\n${p.investigations.gasType}: pH ${v.ph} pCO2 ${v.pco2} pO2 ${v.po2} HCO3 ${v.hco3} BE ${v.be} Lac ${v.lac} Ca ${v.ca}`;
                if(p.investigations.gasType === 'ABG' && v.abgFio2) t+= ` (FiO2: ${v.abgFio2}%)`;
                t += `\nPlan: ${p.investigations.imaging}\n`;
                
                getEl('initialNoteOutput').value = t;

                let s = `**Secondary Survey**\n\n`;
                const vSec = p.investigations.vbgSec;
                if(vSec.ph || vSec.lac) {
                    s += `Repeat ${p.investigations.secGasType}: pH ${vSec.ph} pCO2 ${vSec.pco2} pO2 ${vSec.po2} HCO3 ${vSec.hco3} BE ${vSec.be} Lac ${vSec.lac}\n\n`;
                }

                SS_AREAS.forEach(area => {
                    const data = p.secondary[area.id];
                    if(data) {
                        const hasTags = data.tags.length > 0;
                        const hasText = data.text.length > 0;
                        if (hasTags || hasText) {
                            s += `- ${area.label}: ${data.tags.join(', ')}${hasTags && hasText ? '. ' : ''}${data.text}\n`;
                        }
                    }
                });

                const ne = p.neuroExam;
                s += `\n- Neurological Examination:\n`;
                s += `  UL: L (Pow ${ne.pul}, Sen ${ne.sul}) | R (Pow ${ne.pur}, Sen ${ne.sur})\n`;
                s += `  LL: L (Pow ${ne.pll}, Sen ${ne.sll}) | R (Pow ${ne.plr}, Sen ${ne.slr})\n`;
                
                s += `\n**Definitive Care Plan**\n`;
                if(p.definitive.furtherImaging) s+= `- Further Imaging Required: ${p.definitive.furtherImagingDetails}\n`;
                if(p.definitive.meds.length) s += `- Time Critical Meds Prescribed: ${p.definitive.meds.join(', ')}\n`;
                if(p.definitive.disposition) s += `- Disposition: ${p.definitive.disposition}\n`;
                s += `${p.definitive.plan}\n`;
                
                s += `\n**Problem List**\n${p.problemList}`;
                getEl('secondaryNoteOutput').value = s;
                
                saveState();
            }

            // --- LISTENERS ---
            const bind = (id, obj, key) => { const el = getEl(id); if(el) el.addEventListener('input', e => { obj[key] = e.target.value; updateNotes(); }); };
            const bindCheck = (id, obj, key) => { const el = getEl(id); if(el) el.addEventListener('change', e => { obj[key] = e.target.checked; updateNotes(); }); };

            // Specialties with Timestamp Logic
            document.querySelectorAll('.std-btn').forEach(btn => btn.addEventListener('click', e => {
                e.target.classList.toggle('active');
                if(e.target.dataset.spec) {
                     const specName = e.target.dataset.spec;
                     // Initialize if needed
                     if(!Array.isArray(patientData.arrival.specialties)) patientData.arrival.specialties = [];
                     
                     // Check if exists
                     const existingIdx = patientData.arrival.specialties.findIndex(s => (typeof s === 'string' ? s : s.name) === specName);
                     
                     if(existingIdx === -1) {
                         // Add new with time
                         patientData.arrival.specialties.push({ name: specName, time: getTime() });
                     } else {
                         // Remove
                         patientData.arrival.specialties.splice(existingIdx, 1);
                     }
                }
                // Airway logic...
                if(e.target.dataset.adj) {
                    const adj = e.target.dataset.adj;
                    if(adj === 'None') patientData.airway.adjuncts = ['None'];
                    else {
                        patientData.airway.adjuncts = patientData.airway.adjuncts.filter(x => x !== 'None');
                        if(patientData.airway.adjuncts.includes(adj)) patientData.airway.adjuncts = patientData.airway.adjuncts.filter(x => x !== adj);
                        else patientData.airway.adjuncts.push(adj);
                    }
                    if(adj === 'None') document.querySelectorAll('[data-adj]').forEach(b => { if(b.dataset.adj !== 'None') b.classList.remove('active') });
                    else document.querySelector('[data-adj="None"]').classList.remove('active');
                }
                updateNotes();
            }));

            // ... (Rest of listeners remain standard, using data-attributes for generic handling) ...
            
            getEl('btn-arrival-now').addEventListener('click', () => { patientData.arrival.time = getTime(); updateNotes(); });
            
             document.querySelectorAll('.ph-btn').forEach(btn => btn.addEventListener('click', e => {
                e.target.classList.toggle('active');
                const t = e.target.dataset.t;
                if(patientData.atmist.phTreatments.includes(t)) {
                    patientData.atmist.phTreatments = patientData.atmist.phTreatments.filter(x => x !== t);
                } else {
                    patientData.atmist.phTreatments.push(t);
                }
                updateNotes();
            }));
            bind('ph_treatments_free', patientData.atmist, 'phNotes');

            document.querySelectorAll('.access-btn').forEach(btn => btn.addEventListener('click', e => {
                e.target.classList.toggle('active');
                const txt = e.target.dataset.text;
                if(txt.includes('Binder')) patientData.circulation.binder = !patientData.circulation.binder;
                if(txt.includes('KTD')) patientData.circulation.ktd = !patientData.circulation.ktd;
                if(txt.includes('Tourniquet')) patientData.circulation.tourniquet = !patientData.circulation.tourniquet;
                updateNotes();
            }));

            document.querySelectorAll('.access-chk').forEach(chk => chk.addEventListener('change', e => {
                const val = e.target.value;
                if(e.target.checked) patientData.circulation.lines.push(val);
                else patientData.circulation.lines = patientData.circulation.lines.filter(x => x !== val);
                updateNotes();
            }));

            document.querySelectorAll('.med-check').forEach(chk => chk.addEventListener('change', e => {
                const val = e.target.value;
                if(e.target.checked) patientData.definitive.meds.push(val);
                else patientData.definitive.meds = patientData.definitive.meds.filter(x => x !== val);
                updateNotes();
            }));

            document.querySelectorAll('input[name="gasType"]').forEach(r => r.addEventListener('change', e => {
                patientData.investigations.gasType = e.target.value;
                getEl('gasFio2Container').classList.toggle('hidden', e.target.value !== 'ABG');
                updateNotes();
            }));
            getEl('gasFio2').addEventListener('input', e => { patientData.investigations.vbg.abgFio2 = e.target.value; updateNotes(); });
            
             document.querySelectorAll('input[name="secGasType"]').forEach(r => r.addEventListener('change', e => {
                patientData.investigations.secGasType = e.target.value;
                updateNotes();
            }));

            getEl('furtherImaging').addEventListener('change', e => {
                patientData.definitive.furtherImaging = e.target.checked;
                getEl('furtherImagingDetails').classList.toggle('hidden', !e.target.checked);
                updateNotes();
            });
            bind('furtherImagingDetails', patientData.definitive, 'furtherImagingDetails');

            bind('specialtyAttendances', patientData.arrival, 'specialtiesNotes'); 
            
            bind('age', patientData.atmist, 'age');
            bindCheck('ageEstimated', patientData.atmist, 'ageEst');
            bind('timeOfIncident', patientData.atmist, 'time');
            bind('mechanism', patientData.atmist, 'mech');
            bind('injuries', patientData.atmist, 'inj');
            bind('signs', patientData.atmist, 'signs');
            bind('preHospitalOther', patientData.prehosp, 'notes');
            ['a','m','p','l','e'].forEach(k => bind(`history_${k}`, patientData.prehosp.history, k));

            bindCheck('preHospitalRSI', patientData.airway, 'rsi');
            getEl('preHospitalRSI').addEventListener('change', e => getEl('rsiDetails').classList.toggle('hidden', !e.target.checked));
            ['size','length','grade','etco2','drugs'].forEach(k => bind(`rsi_${k}`, patientData.airway.rsiData, k));

            bindCheck('cspine_collar', patientData.airway, 'collar');
            bindCheck('cspine_blocks', patientData.airway, 'blocks');
            bind('airway_notes', patientData.airway, 'notes');
            document.querySelectorAll('input[name="airwayStatus"]').forEach(r => r.addEventListener('change', e => { patientData.airway.status = e.target.value; updateNotes(); }));

            bind('breathing_rr', patientData.breathing, 'rr');
            bind('breathing_sats', patientData.breathing, 'sats');
            bind('breathing_fio2', patientData.breathing, 'fio2');
            bind('breathing_notes', patientData.breathing, 'notes');
            document.querySelectorAll('input[name="breathing_o2"]').forEach(r => r.addEventListener('change', e => { 
                patientData.breathing.o2 = e.target.value; 
                getEl('fio2_container').classList.toggle('hidden', e.target.value === 'Air');
                updateNotes(); 
            }));

            bind('circ_hr', patientData.circulation, 'hr');
            bind('circ_bp', patientData.circulation, 'bp');
            bind('circ_capRefill', patientData.circulation, 'crt');
            bind('circ_notes', patientData.circulation, 'notes');
            document.querySelectorAll('input[name="txaGiven"]').forEach(r => r.addEventListener('change', e => { patientData.circulation.txa = e.target.value; updateNotes(); }));

            bindCheck('mhp_activated', patientData.mhp, 'activated');
            getEl('mhp_activated').addEventListener('change', e => {
                 getEl('mhpDetails').classList.toggle('hidden', !e.target.checked);
                 getEl('mhp_time').classList.toggle('hidden', !e.target.checked);
                 if(e.target.checked && !patientData.mhp.time) {
                     patientData.mhp.time = getTime();
                     getEl('mhp_time').value = patientData.mhp.time;
                 }
                 updateNotes();
            });
            bind('mhp_time', patientData.mhp, 'time');
            ['prbc','ffp','plt','cryo'].forEach(k => bind(`mhp_${k}`, patientData.mhp, k));

            bindCheck('headInjury', patientData.disability, 'headInjury');
            document.querySelectorAll('input[name="disability_avpu"]').forEach(r => r.addEventListener('change', e => { patientData.disability.avpu = e.target.value; updateNotes(); }));
            
            bind('disability_pupil_left', patientData.disability, 'pupilL');
            bind('disability_pupil_right', patientData.disability, 'pupilR');
            bind('disability_glucose', patientData.disability, 'glucose');

            bind('exposure_temp', patientData.exposure, 'temp');
            bind('exposure_notes', patientData.exposure, 'notes');

            ['ph','pco2','po2','hco3','be','lactate','ionisedCa'].forEach(k => {
                const map = {lactate:'lac', ionisedCa:'ca'};
                bind(`vbgInitial_${k}`, patientData.investigations.vbg, map[k]||k);
            });
            
            ['ph','pco2','po2','hco3','be','lac','ca'].forEach(k => {
                const map = {lactate:'lac', ionisedCa:'ca'};
                bind(`vbgSec_${k}`, patientData.investigations.vbgSec, map[k]||k);
            });

            bind('imagingDecisions', patientData.investigations, 'imaging');
            bind('definitivePlan', patientData.definitive, 'plan');
            bind('problemList', patientData, 'problemList');

            secContainer.addEventListener('change', (e) => {
                const areaId = e.target.dataset.area || e.target.id.replace('ss_', '');
                if (e.target.classList.contains('tag-checkbox')) {
                    const tag = e.target.value;
                    if (e.target.checked) patientData.secondary[areaId].tags.push(tag);
                    else patientData.secondary[areaId].tags = patientData.secondary[areaId].tags.filter(t => t !== tag);
                } else if (e.target.tagName === 'TEXTAREA') {
                    patientData.secondary[areaId].text = e.target.value;
                }
                updateNotes();
            });

            ['Initial', 'Secondary'].forEach(type => {
                const btn = getEl(`copy${type}`);
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(getEl(`${type.toLowerCase()}NoteOutput`).value);
                    const t = btn.textContent; btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent=t, 1500);
                });
            });

            getEl('resetData').addEventListener('click', () => {
                if(confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    localStorage.removeItem('wmebem_trauma_data');
                    location.reload();
                }
            });

            // Restore
            loadState();
            
            // Re-apply "Found" buttons
            patientData.breathing.findings.forEach(obj => {
                const btn = document.querySelector(`.lr-btn[data-f="${obj.f}"][data-s="${obj.s}"]`);
                if(btn) btn.classList.add('active');
            });
            // Re-apply Injury Sites
            patientData.circulation.bleeding.forEach(site => {
                const btn = document.querySelector(`.injury-btn[data-site="${site}"]`);
                if(btn) btn.classList.add('active');
            });
            // Re-apply Secondary Tags
            SS_AREAS.forEach(area => {
                if(patientData.secondary[area.id]) {
                    patientData.secondary[area.id].tags.forEach(tag => {
                        const chk = document.querySelector(`.tag-checkbox[data-area="${area.id}"][value="${tag}"]`);
                        if(chk) chk.checked = true;
                    });
                    const txt = getEl(`ss_${area.id}`);
                    if(txt) txt.value = patientData.secondary[area.id].text;
                }
            });
            // Re-apply GCS selects
            getEl('disability_gcsE').value = patientData.disability.gcsE;
            getEl('disability_gcsV').value = patientData.disability.gcsV;
            getEl('disability_gcsM').value = patientData.disability.gcsM;
            // Re-apply Neuro Exam selects
            Object.keys(patientData.neuroExam).forEach(k => {
                const el = getEl(`neuro_${k}`);
                if(el) el.value = patientData.neuroExam[k];
            });

            updateNotes();
        });
    </script>
</body>
</html>
